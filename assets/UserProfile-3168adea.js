import{a as r,d as o}from"./index-912f96f0.js";import{B as C,x as U,H as f,q as a,J as t,K as p,O as S,N as y,P as E,M as K}from"./firebase-1b009ed5.js";import{S as g}from"./sweetalert2.esm.all-9d2ad45a.js";import{_ as Y}from"./_plugin-vue_export-helper-c27b6911.js";import{r as q,f as L,J as M,w as V,j as c,v as u,y as _,I as O,C as B}from"./vendor-a1a62974.js";const j={class:"section user-profile-section"},J={class:"container"},z={class:"profile-box",style:{position:"relative"}},H={class:"profile-photo-wrapper"},G=["src","alt"],W={class:"profile-title"},X={class:"profile-description"},Z={key:0,class:"friend-actions"},ee=["disabled"],te={key:0,class:"bx bx-loader-alt bx-spin"},se={key:1},oe=["disabled"],ie={key:0,class:"bx bx-loader-alt bx-spin"},re={key:1},ae=["disabled"],ne={key:0,class:"bx bx-loader-alt bx-spin"},de={key:1},ce={key:3,class:"button is-primary mt-2",disabled:""},ue={__name:"UserProfile",props:{uid:String},emits:["close"],setup(T,{emit:le}){const i=T,m=q({name:"",bio:"",photo:""}),d=q(!1),l=q("none"),P=L(()=>{var e;return((e=r.currentUser)==null?void 0:e.uid)===i.uid});async function D(){const e=i.uid;if(e)try{const s=await C(U(o,"users",e));if(s.exists()){const n=s.data();m.value.name=n.name||"",m.value.bio=n.bio||"",m.value.photo=n.photo||""}await Q()}catch(s){console.error("Error cargando perfil:",s)}}async function Q(){if(!(!r.currentUser||!i.uid))try{console.log("=== VERIFICANDO ESTADO DE AMISTAD ==="),console.log("Usuario actual:",r.currentUser.uid),console.log("Usuario objetivo:",i.uid);const e=r.currentUser.uid,s=i.uid,n=f(a(o,"friendships"),t("userId","==",e),t("friendId","==",s)),v=f(a(o,"friendships"),t("userId","==",s),t("friendId","==",e)),[I,h]=await Promise.all([p(n),p(v)]),b=!I.empty||!h.empty;if(console.log("¿Son amigos?",b),b){l.value="friends",console.log("Estado: Ya son amigos");return}const A=f(a(o,"friend_requests"),t("fromUserId","==",e),t("toUserId","==",s),t("status","==","pending"));if(!(await p(A)).empty){l.value="pending_sent",console.log("Estado: Solicitud enviada");return}const N=f(a(o,"friend_requests"),t("fromUserId","==",s),t("toUserId","==",e),t("status","==","pending"));if(!(await p(N)).empty){l.value="pending_received",console.log("Estado: Solicitud recibida");return}l.value="none",console.log("Estado: Sin relación")}catch(e){console.error("Error verificando estado de amistad:",e)}}async function R(){if(!(!r.currentUser||!i.uid)){d.value=!0;try{console.log("=== ENVIANDO SOLICITUD DE AMISTAD ==="),console.log("Usuario actual:",r.currentUser.uid),console.log("Usuario objetivo:",i.uid);const e=r.currentUser,s=r.currentUser.uid,n=i.uid,v=f(a(o,"friendships"),t("userId","==",s),t("friendId","==",n)),I=f(a(o,"friendships"),t("userId","==",n),t("friendId","==",s)),[h,b]=await Promise.all([p(v),p(I)]);if(!h.empty||!b.empty){console.log("Ya son amigos, no se puede enviar solicitud"),g.fire({icon:"warning",title:"Ya son amigos",text:"No puedes enviar una solicitud a alguien que ya es tu amigo",confirmButtonText:"OK"});return}const k=f(a(o,"friend_requests"),t("fromUserId","==",s),t("toUserId","==",n),t("status","==","pending"));if(!(await p(k)).empty){console.log("Ya existe una solicitud pendiente"),g.fire({icon:"warning",title:"Solicitud ya enviada",text:"Ya has enviado una solicitud de amistad a este usuario",confirmButtonText:"OK"});return}const w=await C(U(o,"users",e.uid)),x=w.exists()?w.data():{};await S(a(o,"friend_requests"),{fromUserId:e.uid,toUserId:i.uid,fromUserName:x.name||e.displayName||"Usuario",fromUserEmail:e.email||"",fromUserPhoto:x.photo||e.photoURL||"",status:"pending",createdAt:y(),message:`${x.name||e.displayName||"Usuario"} te envió una solicitud de amistad`}),await S(a(o,"notifications"),{toUserId:i.uid,fromUserId:e.uid,type:"friend_request",title:"Nueva solicitud de amistad",message:`${x.name||e.displayName||"Usuario"} te envió una solicitud de amistad`,read:!1,createdAt:y()}),l.value="pending_sent",console.log("Solicitud enviada correctamente"),g.fire({icon:"success",title:"Solicitud enviada",text:"Se ha enviado la solicitud de amistad",showConfirmButton:!1,timer:2e3})}catch(e){console.error("Error enviando solicitud:",e),g.fire({icon:"error",title:"Error",text:"No se pudo enviar la solicitud",confirmButtonText:"OK"})}finally{d.value=!1}}}async function F(){if(!(!r.currentUser||!i.uid)){d.value=!0;try{const e=f(a(o,"friend_requests"),t("fromUserId","==",r.currentUser.uid),t("toUserId","==",i.uid),t("status","==","pending")),s=await p(e);if(!s.empty){await E(U(o,"friend_requests",s.docs[0].id));const n=f(a(o,"notifications"),t("userId","==",i.uid),t("fromUserId","==",r.currentUser.uid),t("type","==","friend_request"),t("read","==",!1)),v=await p(n);v.empty||await E(U(o,"notifications",v.docs[0].id)),l.value="none",g.fire({icon:"success",title:"Solicitud cancelada",text:"La solicitud de amistad ha sido cancelada",showConfirmButton:!1,timer:2e3})}}catch(e){console.error("Error cancelando solicitud:",e),g.fire({icon:"error",title:"Error",text:"No se pudo cancelar la solicitud",confirmButtonText:"OK"})}finally{d.value=!1}}}async function $(){if(!(!r.currentUser||!i.uid)){d.value=!0;try{console.log("=== ACEPTANDO SOLICITUD DESDE USERPROFILE ==="),console.log("Usuario actual:",r.currentUser.uid),console.log("Usuario a aceptar:",i.uid);const e=f(a(o,"friend_requests"),t("fromUserId","==",i.uid),t("toUserId","==",r.currentUser.uid),t("status","==","pending")),s=await p(e);if(s.empty)console.log("No se encontró la solicitud");else{const n=s.docs[0],v=n.data();console.log("Solicitud encontrada:",v),await K(U(o,"friend_requests",n.id),{status:"accepted",updatedAt:y()}),await S(a(o,"friendships"),{userId:r.currentUser.uid,friendId:i.uid,createdAt:y()}),await S(a(o,"friendships"),{userId:i.uid,friendId:r.currentUser.uid,createdAt:y()}),await S(a(o,"notifications"),{toUserId:i.uid,fromUserId:r.currentUser.uid,type:"friend_request_accepted",title:"Solicitud de amistad aceptada",message:`${m.value.name} aceptó tu solicitud de amistad`,read:!1,createdAt:y()});const I=f(a(o,"notifications"),t("toUserId","==",r.currentUser.uid),t("fromUserId","==",i.uid),t("type","==","friend_request"),t("read","==",!1)),h=await p(I);h.empty||await E(U(o,"notifications",h.docs[0].id)),l.value="friends",console.log("Solicitud aceptada correctamente"),g.fire({icon:"success",title:"¡Amigos!",text:"Ahora son amigos",showConfirmButton:!1,timer:2e3})}}catch(e){console.error("Error aceptando solicitud:",e),g.fire({icon:"error",title:"Error",text:"No se pudo aceptar la solicitud",confirmButtonText:"OK"})}finally{d.value=!1}}}return M(()=>{D()}),V(()=>i.uid,()=>{D()}),(e,s)=>(c(),u("section",j,[_("div",J,[_("div",z,[_("button",{class:"modal-close",onClick:s[0]||(s[0]=n=>e.$emit("close"))},"×"),_("div",H,[_("img",{src:m.value.photo?m.value.photo:`https://ui-avatars.com/api/?name=${encodeURIComponent(m.value.name||"U")}&size=150`,alt:`Foto de ${m.value.name}`,class:"profile-photo"},null,8,G)]),_("h2",W,O(m.value.name),1),_("p",X,O(m.value.bio),1),P.value?B("",!0):(c(),u("div",Z,[l.value==="none"?(c(),u("button",{key:0,class:"button is-success mt-2",onClick:R,disabled:d.value},[d.value?(c(),u("i",te)):(c(),u("span",se,"Agregar como amigo"))],8,ee)):l.value==="pending_sent"?(c(),u("button",{key:1,class:"button is-warning mt-2",onClick:F,disabled:d.value},[d.value?(c(),u("i",ie)):(c(),u("span",re,"Solicitud enviada"))],8,oe)):l.value==="pending_received"?(c(),u("button",{key:2,class:"button is-info mt-2",onClick:$,disabled:d.value},[d.value?(c(),u("i",ne)):(c(),u("span",de,"Aceptar solicitud"))],8,ae)):l.value==="friends"?(c(),u("button",ce,s[1]||(s[1]=[_("i",{class:"bx bx-check"},null,-1),_("span",null,"Ya son amigos",-1)]))):B("",!0)]))])])]))}},ge=Y(ue,[["__scopeId","data-v-19544cc5"]]);export{ge as default};
