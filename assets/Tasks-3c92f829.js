import{r as b,a as W,J as ht,N as kt,w as xt,f as Tt,j as m,v as f,x as Ct,y as s,I as c,K as H,A as h,O as K,F as M,G as S,z as w,B as N,E as I,C as q,L as B,n as Dt}from"./vendor-a1a62974.js";import{d as v,a as wt}from"./index-912f96f0.js";import{p as G,q as V,M as P,x as k,O as L,B as X,N as Nt,P as J}from"./firebase-1b009ed5.js";import{b as R,c as Y}from"./alert-015a1aea.js";import{F as It}from"./FloatingIcons-e36b23d3.js";import{_ as Et}from"./_plugin-vue_export-helper-c27b6911.js";import"./sweetalert2.esm.all-9d2ad45a.js";const $t={class:"tasks-page"},Ot={class:"container"},Vt={class:"columns is-multiline mb-4"},jt={class:"column"},At={class:"card summary-card"},Ft={class:"card-content py-4 px-3"},Ht={class:"is-flex is-align-items-center is-justify-content-space-between"},Mt={class:"title is-4 mb-1"},St={class:"column"},Pt={class:"card summary-card"},Ut={class:"card-content py-4 px-3"},zt={class:"is-flex is-align-items-center is-justify-content-space-between"},Bt={class:"title is-4 mb-1"},Lt={class:"column"},Rt={class:"card summary-card"},Wt={class:"card-content py-4 px-3"},Kt={class:"is-flex is-align-items-center is-justify-content-space-between"},qt={class:"title is-4 mb-1"},Gt={class:"column"},Xt={class:"card summary-card"},Jt={class:"card-content py-4 px-3"},Yt={class:"is-flex is-align-items-center is-justify-content-space-between"},Qt={class:"title is-4 mb-1"},Zt={class:"controls-section mb-4"},ts={class:"is-flex is-justify-content-space-between is-align-items-center"},ss={class:"is-flex is-align-items-center gap-3"},es={class:"is-flex is-align-items-center gap-2"},as={class:"kanban-boards"},os=["onDrop"],is={class:"column-header"},ns={class:"title is-5 has-text-white-ter"},ls={class:"task-count"},rs={class:"column-content"},ds=["id","onDragstart","onClick"],cs={class:"task-header"},us={class:"task-badges"},ps={class:"task-actions"},vs=["onClick"],gs=["onClick"],ms={class:"task-content"},fs={class:"task-title"},bs={class:"task-description"},_s={class:"task-meta"},ys={class:"task-date"},hs={key:0,class:"task-category"},ks={class:"task-footer"},xs={key:0,class:"task-progress"},Ts={class:"progress-bar"},Cs={class:"progress-text"},Ds={key:0,class:"notes-add"},ws={key:1,class:"notes-grid"},Ns=["id","onClick","onDragstart"],Is={class:"note-header"},Es={class:"note-date"},$s=["onClick"],Os={class:"note-content"},Vs={class:"note-title"},js={class:"note-text"},As={class:"modal-card"},Fs={class:"modal-card-head"},Hs={class:"modal-card-title"},Ms={class:"modal-card-body"},Ss={class:"field"},Ps={class:"control"},Us={class:"field"},zs={class:"control"},Bs={class:"columns"},Ls={class:"column is-6"},Rs={class:"field"},Ws={class:"control"},Ks={class:"select is-fullwidth"},qs={class:"column is-6"},Gs={class:"field"},Xs={class:"control"},Js={class:"field"},Ys={class:"control"},Qs={class:"modal-card-foot buttons"},Zs={class:"modal-card"},te={class:"modal-card-head"},se={class:"modal-card-title"},ee={class:"modal-card-body"},ae={class:"field"},oe={class:"control"},ie={class:"field"},ne={class:"control"},le={class:"field"},re={class:"control"},de={class:"color-picker"},ce=["onClick"],ue={class:"modal-card-foot buttons"},pe={__name:"Tasks",setup(ve){const C=async(a,t,e=null)=>{console.log("=== INICIANDO ENVÍO DE NOTIFICACIÓN ==="),console.log("Tipo:",a),console.log("Tarea:",t),console.log("Estado anterior:",e);const o=O();if(o){if(!t||!t.id||!t.title){console.error("Tarea inválida para notificación:",t);return}if((a==="due_soon"||a==="overdue")&&(!t.dueDate||typeof t.dueDate=="string"&&(t.dueDate.includes("mañana")||t.dueDate.includes("tarde")||t.dueDate.includes("hoy")))){console.warn("No se enviará notificación de fecha para tarea sin fecha válida:",t.title);return}try{let n="",l="",r="task_update";switch(a){case"created":n="Nueva Tarea Creada",l=`Has creado la tarea: "${t.title}"`,r="task_created";break;case"completed":n="¡Tarea Completada!",l=`Has completado la tarea: "${t.title}"`,r="task_completed";break;case"progress":n="Tarea en Progreso",l=`Has iniciado la tarea: "${t.title}"`,r="task_progress";break;case"reopened":n="Tarea Reabierta",l=`Has reabierto la tarea: "${t.title}"`,r="task_reopened";break;case"due_soon":n="¡Tarea Vence Pronto!",l=`La tarea "${t.title}" vence en exactamente 1 día`,r="task_due_soon";break;case"overdue":n="¡Tarea Vencida!",l=`La tarea "${t.title}" está vencida`,r="task_overdue";break;default:return}const i=(await X(k(v,"users",o))).data(),p={toUserId:o,fromUserId:o,fromUserName:(i==null?void 0:i.name)||"Usuario",fromUserPhoto:(i==null?void 0:i.photo)||null,type:r,title:n,message:l,taskId:t.id,taskTitle:t.title,oldStatus:e||null,newStatus:t.status||"unknown",read:!1,createdAt:Nt()};console.log("Enviando notificación:",p);const _=await L(V(v,"notifications"),p);console.log("Notificación enviada con ID:",_.id),console.log("=== NOTIFICACIÓN ENVIADA EXITOSAMENTE ===")}catch(n){console.error("Error enviando notificación:",n),console.log("=== ERROR EN ENVÍO DE NOTIFICACIÓN ===")}}},x=b(!1),y=b(!1),D=b(null),E=b(null),j=b(""),T=b(null),A=b(null),u=W({title:"",description:"",priority:"media",dueDate:"",category:"",progress:0,status:"todo"}),g=W({title:"",content:"",color:"#fbbf24"}),$=b([{id:"todo",title:"Por Hacer",tasks:[]},{id:"progress",title:"En Progreso",tasks:[]},{id:"completed",title:"Completadas",tasks:[]}]),U=b([]),O=()=>{var a;return(a=wt.currentUser)==null?void 0:a.uid};ht(()=>{let a=0;const t=6e4;G(V(v,"tasks"),e=>{const o=O();if(!o)return;const l=e.docs.map(d=>({id:d.id,...d.data()})).filter(d=>d.userId===o);$.value.forEach(d=>d.tasks=[]),l.forEach(d=>{const i=$.value.find(p=>p.id===d.status);i&&i.tasks.push(d)});const r=Date.now();l.length>0&&o&&r-a>t&&(a=r,Q(l))}),G(V(v,"notes"),e=>{const o=O();o&&(U.value=e.docs.map(n=>({id:n.id,...n.data()})).filter(n=>n.userId===o))})});const Q=async a=>{if(!a||a.length===0)return;const t=new Date,e=new Date(t);e.setDate(e.getDate()+1),e.setHours(0,0,0,0);const o=new Date(t);o.setHours(0,0,0,0);const n=o.toDateString(),l=JSON.parse(localStorage.getItem(`taskNotifications_${n}`)||"{}");let r=!1,d=0;for(const i of a)if(!(!i||!i.id||!i.title||!i.dueDate||i.status==="completed"))try{if(typeof i.dueDate=="string"&&(i.dueDate.includes("mañana")||i.dueDate.includes("tarde")||i.dueDate.includes("hoy")||i.dueDate.includes("próximo"))){d++,d<=3&&console.warn("Fecha descriptiva inválida para tarea:",i.id,i.dueDate);continue}const p=new Date(i.dueDate);if(isNaN(p.getTime())){d++,d<=3&&console.warn("Fecha inválida para tarea:",i.id,i.dueDate);continue}if(p.setHours(0,0,0,0),p.getTime()===e.getTime()){const _=`due_soon_${i.id}`;l[_]||(console.log("Enviando notificación de tarea que vence pronto:",i.title),await C("due_soon",i),l[_]=!0,r=!0)}if(p.getTime()<o.getTime()){const _=`overdue_${i.id}`;l[_]||(console.log("Enviando notificación de tarea vencida:",i.title),await C("overdue",i),l[_]=!0,r=!0)}}catch(p){console.error("Error procesando fecha de tarea:",i.id,p)}r&&localStorage.setItem(`taskNotifications_${n}`,JSON.stringify(l)),d>0&&console.log(`Se encontraron ${d} tareas con fechas inválidas o descriptivas`)},Z=kt(),tt=b(null);xt(()=>Z.query.highlight,async a=>{if(a){tt.value=a,await Dt();let t=document.getElementById("task-"+a);t&&(t.classList.add("highlighted-search"),setTimeout(()=>{t.classList.remove("highlighted-search")},2e3)),t=document.getElementById("note-"+a),t&&(t.classList.add("highlighted-search"),setTimeout(()=>{t.classList.remove("highlighted-search")},2e3))}},{immediate:!0});const st=async()=>{const a=O();if(a){if(D.value)await P(k(v,"tasks",D.value.id),{...u,userId:a});else{const t=await L(V(v,"tasks"),{...u,userId:a}),e={id:t.id,...u,userId:a};t.id&&e.title&&await C("created",e)}x.value=!1,D.value=null,Object.assign(u,{title:"",description:"",priority:"media",dueDate:"",category:"",progress:0,status:"todo"})}},et=async a=>{(await Y("¿deseas eliminar la tarea?")).isConfirmed&&(await J(k(v,"tasks",a)),R("Tarea eliminada exitosamente"))},at=a=>{D.value=a,Object.assign(u,a),x.value=!0},ot=["#fbbf24","#06d6a0","#6366f1","#64748b","#ef4444","#8b5cf6"],it=a=>{const t=$.value.find(e=>e.id===a);return t?j.value?t.tasks.filter(e=>e.priority===j.value):t.tasks:[]},z=a=>{switch(a.status){case"todo":return 0;case"progress":return 50;case"completed":return 100;default:return 0}},nt=a=>{switch(a.status){case"todo":return"Pendiente";case"progress":return"En Progreso";case"completed":return"Completada";default:return"Pendiente"}},lt=a=>{switch(a.status){case"todo":return"status-pendiente";case"progress":return"status-progreso";case"completed":return"status-completada";default:return"status-pendiente"}},F=Tt(()=>{const a=$.value.flatMap(t=>t.tasks);return{total:a.length,todo:a.filter(t=>t.status==="todo").length,progress:a.filter(t=>t.status==="progress").length,completed:a.filter(t=>t.status==="completed").length}}),rt=a=>{D.value=a,Object.assign(u,a),x.value=!0},dt=a=>{E.value=a,Object.assign(g,a),y.value=!0},ct=async a=>{(await Y("¿quieres eliminar la nota?")).isConfirmed&&(R("Nota eliminada exitosamente"),await J(k(v,"notes",a)))},ut=async()=>{if(!g.title.trim()||!g.content.trim())return;const a=O();a&&(E.value?await P(k(v,"notes",E.value.id),{...g,userId:a}):(await L(V(v,"notes"),{...g,date:new Date().toLocaleDateString(),userId:a,position:{x:100,y:75}}),R("Nota guardada exitosamente")),pt(),y.value=!1)},pt=()=>{Object.assign(g,{title:"",content:"",color:"#fbbf24"}),E.value=null},vt=(a,t)=>{T.value=t,a.target.style.opacity="0.5",a.target.style.transform="rotate(5deg)"},gt=a=>{a.target.style.opacity="1",a.target.style.transform="rotate(0deg)"},mt=async(a,t)=>{if(a.preventDefault(),!T.value||!T.value.id){console.warn("draggedTask es null o no tiene id:",T.value);return}const e=T.value.status,o=T.value.id;try{await P(k(v,"tasks",o),{status:t});const n=await X(k(v,"tasks",o));if(n.exists()){const l=n.data(),r={id:o,...l,status:t};console.log("Tarea obtenida para notificación:",r),e==="completed"&&t==="progress"?await C("reopened",r,e):t==="completed"?await C("completed",r,e):e==="todo"&&t==="progress"&&await C("progress",r,e)}else console.warn("No se encontró la tarea para enviar notificación:",o)}catch(n){console.error("Error al mover la tarea:",n)}finally{T.value=null}},ft=(a,t)=>{A.value=t,a.target.style.opacity="0.6",a.target.style.transform="rotate(3deg) scale(1.05)",a.target.style.zIndex="1000"},bt=a=>{a.target.style.opacity="1",a.target.style.transform="rotate(0deg) scale(1)",a.target.style.zIndex="auto",A.value=null},_t=async a=>{if(a.preventDefault(),!A.value)return;const e=a.currentTarget.getBoundingClientRect(),o=a.clientX-e.left,n=a.clientY-e.top,l=200,r=150,d=e.width,i=e.height,p=Math.max(0,Math.min(o-l/2,d-l)),_=Math.max(0,Math.min(n-r/2,i-r));try{await P(k(v,"notes",A.value.id),{position:{x:p,y:_}})}catch(yt){console.error("Error al mover la nota:",yt)}};return(a,t)=>(m(),f("div",$t,[Ct(It,{viewType:"tasks"}),s("div",Ot,[t[36]||(t[36]=s("div",{class:"page-header"},[s("h1",{class:"title is-2 text-primary"},"Gestión de Tareas"),s("p",{class:"subtitle is-6 text-secondary"}," Organiza y prioriza tus actividades diarias ")],-1)),s("div",Vt,[s("div",jt,[s("div",At,[s("div",Ft,[s("div",Ht,[s("div",null,[s("p",Mt,c(F.value.total),1),t[19]||(t[19]=s("p",{class:"subtitle is-6 text-secondary"},"Total Tareas",-1))]),t[20]||(t[20]=s("span",{class:"icon is-large"},[s("i",{class:"bx bx-task text-primary is-size-2"})],-1))])])])]),s("div",St,[s("div",Pt,[s("div",Ut,[s("div",zt,[s("div",null,[s("p",Bt,c(F.value.todo),1),t[21]||(t[21]=s("p",{class:"subtitle is-6 text-secondary"},"Pendientes",-1))]),t[22]||(t[22]=s("span",{class:"icon is-large"},[s("i",{class:"bx bx-time text-secondary is-size-2"})],-1))])])])]),s("div",Lt,[s("div",Rt,[s("div",Wt,[s("div",Kt,[s("div",null,[s("p",qt,c(F.value.progress),1),t[23]||(t[23]=s("p",{class:"subtitle is-6 text-secondary"},"En Progreso",-1))]),t[24]||(t[24]=s("span",{class:"icon is-large"},[s("i",{class:"bx bx-loader-alt text-info is-size-2"})],-1))])])])]),s("div",Gt,[s("div",Xt,[s("div",Jt,[s("div",Yt,[s("div",null,[s("p",Qt,c(F.value.completed),1),t[25]||(t[25]=s("p",{class:"subtitle is-6 text-secondary"},"Completadas",-1))]),t[26]||(t[26]=s("span",{class:"icon is-large"},[s("i",{class:"bx bx-check-circle text-success is-size-2"})],-1))])])])])]),s("div",Zt,[s("div",ts,[s("div",ss,[s("button",{class:"btn btn-primary",onClick:t[0]||(t[0]=e=>x.value=!0)},t[27]||(t[27]=[s("i",{class:"bx bx-plus mr-2"},null,-1),H("Nueva Tarea ")])),s("button",{class:"btn btn-accent",onClick:t[1]||(t[1]=e=>y.value=!0)},t[28]||(t[28]=[s("i",{class:"bx bx-sticker mr-2"},null,-1),H("Agregar Nota ")]))]),s("div",es,[t[30]||(t[30]=s("span",{class:"text-secondary"},"Filtrar por:",-1)),h(s("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>j.value=e),class:"select is-small select-month"},t[29]||(t[29]=[s("option",{value:""},"Todas las prioridades",-1),s("option",{value:"alta"},"Alta",-1),s("option",{value:"media"},"Media",-1),s("option",{value:"baja"},"Baja",-1)]),512),[[K,j.value]])])])]),s("div",as,[(m(!0),f(M,null,S($.value,e=>(m(),f("div",{class:"kanban-column",key:e.id,onDragover:t[3]||(t[3]=w(()=>{},["prevent"])),onDrop:o=>mt(o,e.id)},[s("div",is,[s("h3",ns,c(e.title),1),s("span",ls,c(e.tasks.length),1)]),s("div",rs,[(m(!0),f(M,null,S(it(e.id),o=>(m(),f("div",{key:o.id,id:"task-"+o.id,class:I(["task-card draggable","priority-"+o.priority]),draggable:"true",onDragstart:n=>vt(n,o),onDragend:gt,onClick:n=>rt(o)},[s("div",cs,[s("div",us,[s("span",{class:I(["task-priority-badge","priority-"+o.priority])},c(o.priority),3),s("span",{class:I(["task-status-badge",lt(o)])},c(nt(o)),3)]),s("div",ps,[s("button",{class:"btn-icon",onClick:w(n=>at(o),["stop"])},t[31]||(t[31]=[s("i",{class:"bx bx-edit"},null,-1)]),8,vs),s("button",{class:"btn-icon",onClick:w(n=>et(o.id),["stop"])},t[32]||(t[32]=[s("i",{class:"bx bx-trash"},null,-1)]),8,gs)])]),s("div",ms,[s("h4",fs,c(o.title),1),s("p",bs,c(o.description),1),s("div",_s,[s("span",ys,[t[33]||(t[33]=s("i",{class:"bx bx-calendar mr-1"},null,-1)),H(c(o.dueDate),1)]),o.category?(m(),f("span",hs,[t[34]||(t[34]=s("i",{class:"bx bx-tag mr-1"},null,-1)),H(c(o.category),1)])):q("",!0)])]),s("div",ks,[z(o)>0?(m(),f("div",xs,[s("div",Ts,[s("div",{class:"progress-fill",style:B({width:z(o)+"%"})},null,4)]),s("span",Cs,c(z(o))+"%",1)])):q("",!0)])],42,ds))),128))])],40,os))),128))]),s("div",{class:"notes-section mt-5",onClick:t[4]||(t[4]=e=>y.value=!0),style:{cursor:"pointer"},onDragover:t[5]||(t[5]=w(()=>{},["prevent"])),onDrop:t[6]||(t[6]=e=>_t(e))},[U.value.length===0?(m(),f("div",Ds,"Agregar notas")):(m(),f("div",ws,[(m(!0),f(M,null,S(U.value,e=>(m(),f("div",{key:e.id,id:"note-"+e.id,class:"note-sticker draggable",style:B({backgroundColor:e.color,position:e.position?"absolute":"relative",left:e.position?e.position.x+"px":"auto",top:e.position?e.position.y+"px":"auto"}),draggable:"true",onClick:w(o=>dt(e),["stop"]),onDragstart:o=>ft(o,e),onDragend:bt},[s("div",Is,[s("span",Es,c(e.date),1),s("button",{class:"btn-icon",onClick:w(o=>ct(e.id),["stop"])},t[35]||(t[35]=[s("i",{class:"bx bx-x"},null,-1)]),8,$s)]),s("div",Os,[s("h4",Vs,c(e.title),1),s("p",js,c(e.content),1)])],44,Ns))),128))]))],32)]),s("div",{class:I(["modal",{"is-active":x.value}])},[s("div",{class:"modal-background",onClick:t[7]||(t[7]=e=>x.value=!1)}),s("div",As,[s("header",Fs,[s("p",Hs,c(D.value?"Editar Tarea":"Nueva Tarea"),1)]),s("section",Ms,[s("div",Ss,[t[37]||(t[37]=s("label",{class:"label"},"Título",-1)),s("div",Ps,[h(s("input",{"onUpdate:modelValue":t[8]||(t[8]=e=>u.title=e),class:"input",type:"text",placeholder:"Título de la tarea"},null,512),[[N,u.title]])])]),s("div",Us,[t[38]||(t[38]=s("label",{class:"label"},"Descripción",-1)),s("div",zs,[h(s("textarea",{"onUpdate:modelValue":t[9]||(t[9]=e=>u.description=e),class:"textarea",placeholder:"Descripción de la tarea"},null,512),[[N,u.description]])])]),s("div",Bs,[s("div",Ls,[s("div",Rs,[t[40]||(t[40]=s("label",{class:"label"},"Prioridad",-1)),s("div",Ws,[s("div",Ks,[h(s("select",{"onUpdate:modelValue":t[10]||(t[10]=e=>u.priority=e)},t[39]||(t[39]=[s("option",{value:"baja"},"Baja",-1),s("option",{value:"media"},"Media",-1),s("option",{value:"alta"},"Alta",-1)]),512),[[K,u.priority]])])])])]),s("div",qs,[s("div",Gs,[t[41]||(t[41]=s("label",{class:"label"},"Fecha límite",-1)),s("div",Xs,[h(s("input",{"onUpdate:modelValue":t[11]||(t[11]=e=>u.dueDate=e),class:"input",type:"date"},null,512),[[N,u.dueDate]])])])])]),s("div",Js,[t[42]||(t[42]=s("label",{class:"label"},"Categoría",-1)),s("div",Ys,[h(s("input",{"onUpdate:modelValue":t[12]||(t[12]=e=>u.category=e),class:"input",type:"text",placeholder:"Categoría (opcional)"},null,512),[[N,u.category]])])])]),s("footer",Qs,[s("button",{class:"btn btn-primary",onClick:st},"Guardar"),s("button",{class:"btn button is-danger has-text-white-bis",onClick:t[13]||(t[13]=e=>x.value=!1)}," Cancelar ")])])],2),s("div",{class:I(["modal",{"is-active":y.value}])},[s("div",{class:"modal-background",onClick:t[14]||(t[14]=e=>y.value=!1)}),s("div",Zs,[s("header",te,[s("p",se,c(E.value?"Editar Nota":"Nueva Nota"),1),s("button",{class:"delete",onClick:t[15]||(t[15]=e=>y.value=!1)})]),s("section",ee,[s("div",ae,[t[43]||(t[43]=s("label",{class:"label"},"Título",-1)),s("div",oe,[h(s("input",{"onUpdate:modelValue":t[16]||(t[16]=e=>g.title=e),class:"input",type:"text",placeholder:"Título de la nota"},null,512),[[N,g.title]])])]),s("div",ie,[t[44]||(t[44]=s("label",{class:"label"},"Contenido",-1)),s("div",ne,[h(s("textarea",{"onUpdate:modelValue":t[17]||(t[17]=e=>g.content=e),class:"textarea",placeholder:"Contenido de la nota"},null,512),[[N,g.content]])])]),s("div",le,[t[45]||(t[45]=s("label",{class:"label"},"Color",-1)),s("div",re,[s("div",de,[(m(),f(M,null,S(ot,e=>s("div",{key:e,class:I(["color-option",{selected:g.color===e}]),style:B({backgroundColor:e}),onClick:o=>g.color=e},null,14,ce)),64))])])])]),s("footer",ue,[s("button",{class:"btn btn-primary",onClick:ut},"Guardar"),s("button",{class:"btn button is-danger has-text-white-bis",onClick:t[18]||(t[18]=e=>y.value=!1)}," Cancelar ")])])],2)]))}},ke=Et(pe,[["__scopeId","data-v-f91eaafc"]]);export{ke as default};
