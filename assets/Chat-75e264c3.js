import{U as Qe,r as m,s as He,w as ce,f as ue,J as Ge,V as qe,j as l,v as d,x as Je,y as n,F as K,G as W,E as z,I as E,C as g,K as X,L as Y,u as V,z as me,A as Fe,B as ve,n as Ke}from"./vendor-a1a62974.js";import{q as h,K as x,x as k,B as pe,z as Z,T as b,H as _,J as A,M as ee,I as fe,p as se,O as ge,P as We,R as he,S as Xe,U as Ye,V as Ze,N as es}from"./firebase-1b009ed5.js";import{d as p,a,b as Ie}from"./index-912f96f0.js";import{F as ss}from"./FloatingIcons-e36b23d3.js";import{_ as ts}from"./_plugin-vue_export-helper-c27b6911.js";const os={class:"chat-page"},ns={class:"columns"},as={class:"column is-one-quarter"},is={class:"box"},rs={key:0,class:"has-text-centered py-4"},ls={key:1,class:"has-text-centered py-4"},ds={key:2},cs=["onClick"],us={class:"is-flex is-align-items-center"},ms={class:"user-name"},Fs={class:"user-actions is-flex"},vs={key:0,class:"notification-badge"},ps={class:"column"},fs={class:"box"},gs={class:"title is-4"},hs={key:1},Is={key:0,class:"no-chat-selected"},Cs={key:1,class:"no-messages"},Us={key:2,class:"messages-list"},ys={class:"message-header"},bs={class:"message-time-container"},_s={class:"message-time"},As={key:0,class:"edited-indicator"},ws=["onClick"],Es={class:"message-content"},xs=["innerHTML"],ks={key:1,class:"pending-message"},Ts={class:"message-menu-content"},Ms=["onClick"],Ds=["onClick"],Ss={key:0,class:"edit-message-container"},Rs={class:"edit-message-input-container"},Ns=["disabled"],Os={key:1,class:"message-input-container"},js={key:2,type:"submit",class:"button is-primary"},Bs={key:0,class:"emoji-picker"},$s={class:"emoji-list"},Ls=["onClick"],Ps=Qe({__name:"Chat",setup(zs){const R=m([]),F=m(null),N=m([]),U=m(""),O=m(null),j=m(null),I=m({}),f=m({}),Q=m({}),H=m(!0),G=m(!1);m(!1);const T=m(null),y=m(null),C=m(""),B=m(new Set),$=m(new Map),M=m([]);He(),typeof window<"u"&&(window.activeChatUserId=null),ce(F,e=>{typeof window<"u"&&(window.activeChatUserId=e?e.uid:null)});const te=e=>B.value.has(e),Ce=async()=>{if(!a.currentUser)return;const e=he(Ie,`status/${a.currentUser.uid}`);await Xe(e,{online:!0,lastSeen:Date.now(),uid:a.currentUser.uid}),await Ye(e).set({online:!1,lastSeen:Date.now(),uid:a.currentUser.uid})},oe=e=>{if($.value.has(e))return;const s=he(Ie,`status/${e}`),t=Ze(s,o=>{const i=o.val();i&&i.online?B.value.add(e):B.value.delete(e)});$.value.set(e,t)},Ue=()=>{$.value.forEach(e=>{e&&e()}),$.value.clear(),B.value.clear()},ye=["😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😍","😘","🥰","😗","😙","😚","🙂","🤗","🤔","🤨","😐","😑","😶","🙄","😏","😣","😥","😮","🤐","😯","😪","😫","😴","😌","😛","😜","😝","🤤","😒","😓","😔","😕","🙃","🤑","😲","☹️","🙁","😖","😞","😟","😤","😢","😭","😦","😧","😨","😩","🤯","👍","👎","👏","🙌","👌","✌️","🤘","🤙","👋","❤️","💔","💯","🔥","⚡","🌟","💤","💭","🎵","🎶","🎂"],be=h(p,"users"),L=h(p,"messages"),q=h(p,"readStatus"),ne=["#FF5733","#33A8FF","#33FF57","#FF33A8","#A833FF","#FF8C33","#33FFC5","#FF33F5","#C5FF33","#337BFF","#FF5E3A","#3AFF8C","#8C3AFF","#FFD13A","#3AFFD1","#F5A533","#33FFCC","#F533FF","#FF3357","#33FF92","#FF8CFF","#C533FF","#33FF57","#FF335B","#FF8C80","#33F5A8","#8CFF33","#A8FF33","#33FF72","#FF6333","#FF57E5","#33C5FF","#F7FF33","#F533D1","#FF6B33","#C533A8","#6CFF33","#33FF6C","#3AFF5C","#FF3A8C","#9BFF33","#6B33FF","#33FF48","#A8FF8C","#FF91A8","#33FFEC","#FF336B","#F5FF33","#FF33B3","#C733FF","#F533FF","#FF33F7","#8CFFFB","#FF8CF3","#7CFF33","#FF33AA","#C8FF33","#8CFFCC","#33C9FF","#FF3377","#A8FF75","#FF75A8","#FF33C5","#A8336B","#B333FF","#3A8CFF","#33FF97","#FF3333","#FF339D","#33FFFD","#FF7F33","#33D1FF","#8CFF57","#FF33F0","#A833FF","#D8FF33","#5733FF","#FF3A8C","#FF6342","#4BFF33","#B9FF33"],ae=ue(()=>{if(!a.currentUser)return[];console.log("=== FILTRANDO USUARIOS ==="),console.log("Total de usuarios:",R.value.length),console.log("Usuario actual:",a.currentUser.uid);const e=R.value.filter(s=>{var o;if(s.uid===((o=a.currentUser)==null?void 0:o.uid))return console.log(`Excluyendo usuario actual: ${s.name}`),!1;if(!s.name||!s.email)return console.log(`Usuario sin nombre o email: ${s.uid}`),!1;const t=de(s.uid);return console.log(`Usuario ${s.name} (${s.uid}): ¿Es amigo? ${t}`),t});return console.log("Usuarios filtrados (amigos):",e),console.log("Total de amigos en la lista:",e.length),console.log("=== FIN FILTRADO ==="),e}),_e=ue(()=>[...[...N.value].filter(s=>s.timestamp).sort((s,t)=>{const o=i=>i.toMillis?i.toMillis():i.seconds?i.seconds*1e3:new Date(i).getTime();return o(s.timestamp)-o(t.timestamp)}),...M.value]),P=e=>{if(!Q.value[e]){const t=e.split("").reduce((o,i)=>o+i.charCodeAt(0),0)%ne.length;Q.value[e]=ne[t]}return Q.value[e]},Ae=e=>{if(!e)return"";const s=e.toDate(),t=s.getHours().toString().padStart(2,"0"),o=s.getMinutes().toString().padStart(2,"0");return`${t}:${o}`},we=e=>{const s=/(https?:\/\/[^\s]+)/g;return e.replace(s,o=>`<a href="${o}" target="_blank" class="message-link">${o}</a>`)},Ee=async()=>{console.log("=== INICIANDO LOADUSERS ==="),H.value=!0;try{console.log("Cargando amigos..."),await ze(),console.log("Configurando listener de friendships...");const e=Ve();e?(J.value.push(e),console.log("Listener de friendships configurado correctamente")):console.log("ERROR: No se pudo configurar el listener de friendships"),console.log("Cargando usuarios...");const s=await x(be),t=[];for(const o of s.docs){const i=o.data();i.name&&i.email&&t.push({uid:o.id,...i})}if(R.value=t,console.log("Usuarios cargados:",t.length),a.currentUser){const o=s.docs.find(i=>{var c;return i.id===((c=a.currentUser)==null?void 0:c.uid)});o&&o.data().name&&(O.value={uid:o.id,...o.data()},await xe(),Ce(),oe(a.currentUser.uid))}t.forEach(o=>{P(o.uid),oe(o.uid)}),De(),console.log("=== LOADUSERS COMPLETADO ===")}catch(e){console.error("Error al cargar usuarios:",e)}finally{H.value=!1}},xe=async()=>{if(a.currentUser)try{const e=k(q,a.currentUser.uid),s=await pe(e);s.exists()?f.value=s.data():await Z(e,{}),ke()}catch(e){console.error("Error al cargar el estado de lectura:",e)}},ke=async()=>{var e;if(a.currentUser)for(const s of R.value){if(s.uid===a.currentUser.uid)continue;const t=((e=f.value[s.uid])==null?void 0:e.lastReadTimestamp)||new b(0,0),o=_(L,A("senderId","==",s.uid),A("receiverId","==",a.currentUser.uid),A("timestamp",">",t)),i=await x(o);I.value[s.uid]=i.size}},Te=async e=>{if(F.value=e,Me(),a.currentUser){const s=b.now();f.value[e.uid]?f.value[e.uid].lastReadTimestamp=s:f.value[e.uid]={lastReadTimestamp:s};const t=k(q,a.currentUser.uid);await ee(t,{[e.uid]:{lastReadTimestamp:s}}).catch(async o=>{o.code==="not-found"?await Z(t,{[e.uid]:{lastReadTimestamp:s}}):console.error("Error al actualizar el estado de lectura:",o)}),I.value[e.uid]=0}},Me=()=>{if(!F.value||!a.currentUser)return;const e=_(L,fe("timestamp"));se(e,s=>{N.value=s.docs.map(t=>({id:t.id,...t.data()})).filter(t=>{var c,u;const o=(c=a.currentUser)==null?void 0:c.uid,i=(u=F.value)==null?void 0:u.uid;return t.senderId===o&&t.receiverId===i||t.senderId===i&&t.receiverId===o}),le()})},De=()=>{if(!a.currentUser)return;const e=_(L,fe("timestamp")),s=b.now();se(e,t=>{t.docChanges().forEach(o=>{var i,c,u;if(o.type==="added"){const r={uid:o.doc.uid,...o.doc.data()};if(r.receiverId===((i=a.currentUser)==null?void 0:i.uid)&&r.senderId!==((c=a.currentUser)==null?void 0:c.uid)&&r.timestamp.toDate()>s.toDate())if(!F.value||F.value.uid!==r.senderId){const w=((u=f.value[r.senderId])==null?void 0:u.lastReadTimestamp)||new b(0,0);r.timestamp>w&&(I.value[r.senderId]||(I.value[r.senderId]=0),I.value[r.senderId]++)}else Se(r.senderId)}})})},Se=async e=>{if(!a.currentUser)return;const s=b.now();f.value[e]?f.value[e].lastReadTimestamp=s:f.value[e]={lastReadTimestamp:s};const t=k(q,a.currentUser.uid);await ee(t,{[e]:{lastReadTimestamp:s}}).catch(async o=>{o.code==="not-found"?await Z(t,{[e]:{lastReadTimestamp:s}}):console.error("Error al actualizar el estado de lectura:",o)}),I.value[e]=0},ie=()=>{G.value=!G.value},Re=e=>{T.value===e?T.value=null:T.value=e},re=()=>{T.value=null},Ne=e=>{y.value=e,C.value=e.text,re()},Oe=async()=>{if(!(!y.value||!C.value.trim()))try{const e=k(p,"messages",y.value.id);await ee(e,{text:C.value.trim(),edited:!0,editedAt:b.now()}),y.value=null,C.value=""}catch(e){console.error("Error al editar el mensaje:",e)}},je=()=>{y.value=null,C.value=""},Be=e=>{U.value+=e},$e=async e=>{if(e.senderId===e.receiverId||!de(e.receiverId)||typeof window<"u"&&window.activeChatUserId===e.senderId)return;const s=await pe(k(p,"users",e.senderId)),t=s.exists()?s.data():{},o={toUserId:e.receiverId,fromUserId:e.senderId,fromUserName:t.name||e.author||"Usuario",fromUserPhoto:t.photo||null,type:"dm_message",title:"Nuevo mensaje de tu amigo",message:e.text,chatUserId:e.senderId,read:!1,createdAt:es()};await ge(h(p,"notifications"),o)},Le=async()=>{if(!U.value.trim()||!F.value||!O.value||!a.currentUser)return;const s={id:`pending-${Date.now()}-${Math.random()}`,text:U.value,author:O.value.name,senderId:a.currentUser.uid,receiverId:F.value.uid,pending:!0};M.value.push(s);const t={text:U.value,author:O.value.name,timestamp:b.now(),senderId:a.currentUser.uid,receiverId:F.value.uid,read:!1};await ge(L,t),await $e(t),U.value="",le()},Pe=async e=>{try{await We(k(p,"messages",e)),console.log("Mensaje eliminado correctamente")}catch(s){console.error("Error al eliminar el mensaje:",s)}},le=async()=>{await Ke(),j.value&&(j.value.scrollTop=j.value.scrollHeight)};ce(N,e=>{M.value.length&&(M.value=M.value.filter(s=>!e.some(t=>!t.pending&&t.text===s.text&&t.author===s.author&&t.senderId===s.senderId&&t.receiverId===s.receiverId&&t.timestamp)))}),Ge(()=>{var e;console.log("=== COMPONENTE CHAT MONTADO ==="),console.log("Usuario autenticado:",(e=a.currentUser)==null?void 0:e.uid),Ee(),document.addEventListener("click",s=>{const t=s.target;!t.closest(".message-menu-modal")&&!t.closest(".message-menu-button")&&!t.closest(".message-time-container")&&re()})}),qe(()=>{Ue(),J.value.forEach(e=>{e&&e()}),J.value=[]});const de=e=>{if(!a.currentUser)return!1;console.log("=== VERIFICANDO AMISTAD ==="),console.log("Usuario actual:",a.currentUser.uid),console.log("Amigo a verificar:",e),console.log("Total de friendships cargadas:",D.value.length),console.log("Friendships:",D.value);const s=D.value.some(t=>{var c,u;const o=t.userId===((c=a.currentUser)==null?void 0:c.uid)&&t.friendId===e,i=t.userId===e&&t.friendId===((u=a.currentUser)==null?void 0:u.uid);return console.log(`Friendship ${t.id}:`,{friendship:t,condition1:o,condition2:i,matches:o||i}),o||i});return console.log("¿Es amigo?",s),console.log("=== FIN VERIFICACIÓN ==="),s},D=m([]),J=m([]),ze=async()=>{if(a.currentUser){console.log("=== INICIANDO CARGA DE AMIGOS ==="),console.log("Usuario actual:",a.currentUser.uid);try{const e=_(h(p,"friendships"),A("userId","==",a.currentUser.uid));console.log("Query 1 (userId):",e);const s=await x(e);console.log("Snapshot 1 docs:",s.docs.length);const t=_(h(p,"friendships"),A("friendId","==",a.currentUser.uid));console.log("Query 2 (friendId):",t);const o=await x(t);console.log("Snapshot 2 docs:",o.docs.length);const i=[],c=new Set;s.forEach(u=>{const r=u.data();console.log("Friendship 1:",r),c.has(r.friendId)||(i.push({id:u.id,userId:r.userId,friendId:r.friendId,createdAt:r.createdAt}),c.add(r.friendId))}),o.forEach(u=>{const r=u.data();console.log("Friendship 2:",r),c.has(r.userId)||(i.push({id:u.id,userId:r.userId,friendId:r.friendId,createdAt:r.createdAt}),c.add(r.userId))}),D.value=i,console.log("Amigos cargados:",i),console.log("Total de amigos únicos:",i.length)}catch(e){console.error("Error al cargar amigos:",e)}}},Ve=()=>{if(!a.currentUser){console.log("No hay usuario autenticado para configurar listener");return}console.log("=== CONFIGURANDO LISTENER DE FRIENDSHIPS ==="),console.log("Usuario actual:",a.currentUser.uid);const e=async()=>{try{const o=_(h(p,"friendships"),A("userId","==",a.currentUser.uid)),i=_(h(p,"friendships"),A("friendId","==",a.currentUser.uid)),[c,u]=await Promise.all([x(o),x(i)]);console.log("Snapshot 1 docs:",c.docs.length),console.log("Snapshot 2 docs:",u.docs.length);const r=[],w=new Set;c.forEach(S=>{const v=S.data();console.log("Friendship 1:",v),w.has(v.friendId)||(r.push({id:S.id,userId:v.userId,friendId:v.friendId,createdAt:v.createdAt}),w.add(v.friendId))}),u.forEach(S=>{const v=S.data();console.log("Friendship 2:",v),w.has(v.userId)||(r.push({id:S.id,userId:v.userId,friendId:v.friendId,createdAt:v.createdAt}),w.add(v.userId))}),D.value=r,console.log("Amigos actualizados en tiempo real:",r),console.log("Total de amigos únicos:",r.length)}catch(o){console.error("Error actualizando friendships:",o)}},s=h(p,"friendships"),t=se(s,o=>{console.log("=== CAMBIO DETECTADO EN FRIENDSHIPS ==="),console.log("Cambios:",o.docChanges().length),o.docChanges().forEach(i=>{console.log("Tipo de cambio:",i.type),console.log("Documento:",i.doc.data())}),e()});return e(),t};return(e,s)=>(l(),d("div",os,[Je(ss,{viewType:"chat"}),n("div",ns,[n("div",as,[n("div",is,[s[5]||(s[5]=n("h2",{class:"title is-4"},"Mis Amigos",-1)),H.value?(l(),d("div",rs,s[3]||(s[3]=[n("span",{class:"icon is-large"},[n("i",{class:"bx bx-loader-alt bx-spin"})],-1),n("p",null,"Cargando amigos...",-1)]))):ae.value.length===0?(l(),d("div",ls,s[4]||(s[4]=[n("span",{class:"icon is-large"},[n("i",{class:"bx bx-user-plus"})],-1),n("p",{class:"mt-2"},"No tienes amigos aún",-1),n("p",{class:"is-size-7 has-text-grey"}," Agrega amigos desde el feed para poder chatear ",-1)]))):(l(),d("ul",ds,[(l(!0),d(K,null,W(ae.value,t=>(l(),d("li",{key:t.uid,onClick:o=>Te(t),class:z([{"is-active":F.value&&F.value.uid===t.uid},"is-flex is-align-items-center is-justify-content-space-between"])},[n("div",us,[n("div",{class:z(["user-status-indicator mr-2",{"is-online":te(t.uid),"is-offline":!te(t.uid)}])},null,2),n("div",ms,E(t.name),1)]),n("div",Fs,[I.value[t.uid]?(l(),d("span",vs,E(I.value[t.uid]),1)):g("",!0)])],10,cs))),128))]))])]),n("div",ps,[n("div",fs,[n("h2",gs,[s[6]||(s[6]=X(" Chat con ")),F.value?(l(),d("span",{key:0,style:Y({color:P(F.value.uid)})},E(F.value.name),5)):(l(),d("span",hs,"..."))]),n("div",{class:"messages",ref_key:"messagesContainer",ref:j},[F.value?N.value.length===0?(l(),d("div",Cs,s[8]||(s[8]=[n("p",null,"No hay mensajes aún. ¡Envía el primer mensaje!",-1)]))):(l(),d("div",Us,[(l(!0),d(K,null,W(_e.value,t=>{var o,i,c,u;return l(),d("div",{key:t.id,class:z(["message-wrapper",t.senderId===((o=V(a).currentUser)==null?void 0:o.uid)?"sent":"received"])},[n("div",{class:z(["message-bubble",t.senderId===((i=V(a).currentUser)==null?void 0:i.uid)?"sent-bubble":"received-bubble"]),style:Y(t.senderId!==((c=V(a).currentUser)==null?void 0:c.uid)?{borderColor:P(t.senderId)}:{})},[n("div",ys,[n("span",{class:"message-author",style:Y({color:P(t.senderId)})},E(t.author),5),n("div",bs,[n("span",_s,[X(E(Ae(t.timestamp))+" ",1),t.edited?(l(),d("span",As,"(editado)")):g("",!0)]),t.senderId===((u=V(a).currentUser)==null?void 0:u.uid)?(l(),d("button",{key:0,onClick:r=>Re(t.id),class:"message-menu-button",title:"Opciones del mensaje"},s[9]||(s[9]=[n("span",{class:"icon is-small"},[n("i",{class:"bx bx-dots-vertical-rounded"})],-1)]),8,ws)):g("",!0)])]),n("div",Es,[t.text?(l(),d("div",{key:0,innerHTML:we(t.text)},null,8,xs)):g("",!0),t.pending?(l(),d("div",ks,s[10]||(s[10]=[n("i",{class:"bx bx-loader-alt bx-spin"},null,-1),X(" Enviando... ")]))):g("",!0)]),T.value===t.id?(l(),d("div",{key:0,class:"message-menu-modal",onClick:s[0]||(s[0]=me(()=>{},["stop"]))},[n("div",Ts,[n("button",{onClick:r=>Ne(t),class:"menu-option edit-option"},s[11]||(s[11]=[n("span",{class:"icon is-small"},[n("i",{class:"bx bx-edit"})],-1),n("span",null,"Editar",-1)]),8,Ms),n("button",{onClick:r=>Pe(t.id),class:"menu-option delete-option"},s[12]||(s[12]=[n("span",{class:"icon is-small"},[n("i",{class:"bx bx-trash"})],-1),n("span",null,"Eliminar",-1)]),8,Ds)])])):g("",!0)],6)],2)}),128))])):(l(),d("div",Is,s[7]||(s[7]=[n("p",null,"Selecciona un usuario para comenzar a chatear",-1)])))],512),F.value?(l(),d("form",{key:0,onSubmit:me(Le,["prevent"]),class:"message-form"},[y.value?(l(),d("div",Ss,[n("div",{class:"edit-message-header"},[s[14]||(s[14]=n("span",{class:"edit-label"},"Editando mensaje:",-1)),n("button",{onClick:je,class:"cancel-edit-button"},s[13]||(s[13]=[n("span",{class:"icon is-small"},[n("i",{class:"bx bx-x"})],-1)]))]),n("div",Rs,[Fe(n("input",{"onUpdate:modelValue":s[1]||(s[1]=t=>C.value=t),placeholder:"Editar mensaje...",class:"input edit-input"},null,512),[[ve,C.value]]),n("button",{onClick:Oe,class:"button is-success is-small",disabled:!C.value.trim()},s[15]||(s[15]=[n("span",{class:"icon is-small"},[n("i",{class:"bx bx-check"})],-1)]),8,Ns)])])):(l(),d("div",Os,[Fe(n("input",{"onUpdate:modelValue":s[2]||(s[2]=t=>U.value=t),placeholder:"Escribe un mensaje...",class:"input"},null,512),[[ve,U.value]]),n("button",{type:"button",onClick:ie,class:"emoji-button",title:"Emojis"},s[16]||(s[16]=[n("span",{class:"icon"},[n("i",{class:"bx bx-smile"})],-1)]))])),y.value?g("",!0):(l(),d("button",js,s[17]||(s[17]=[n("span",{class:"icon"},[n("i",{class:"bx bx-send"})],-1)])))],32)):g("",!0)])]),G.value?(l(),d("div",Bs,[n("div",{class:"emoji-picker-header"},[s[18]||(s[18]=n("h4",null,"Emojis",-1)),n("button",{onClick:ie,class:"close-button"},"×")]),n("div",$s,[(l(),d(K,null,W(ye,t=>n("button",{key:t,onClick:o=>Be(t),class:"emoji-item"},E(t),9,Ls)),64))])])):g("",!0)])]))}});const Js=ts(Ps,[["__scopeId","data-v-14f2da99"]]);export{Js as default};
