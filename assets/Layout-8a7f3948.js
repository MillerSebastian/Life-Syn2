import{s as ie,r as $,w as le,D as de,j as n,v as r,y as a,E as w,F as Q,G as K,x as M,H as Ne,I as N,C as f,f as P,a as L,J as $e,A as te,B as ae,z as oe,K as B,L as ne,M as Ee}from"./vendor-a1a62974.js";import{_ as J}from"./_plugin-vue_export-helper-c27b6911.js";import{u as Te,a as p,d as i}from"./index-912f96f0.js";import{H as j,I as Se,J as I,q as y,K as H,B as V,p as De,M as F,x as C,N as k,O as D,P as re,j as Le,Q as Ae}from"./firebase-1b009ed5.js";import"./sweetalert2.esm.all-9d2ad45a.js";/* empty css                                                                */import{b as A,a as O}from"./alert-015a1aea.js";const Me={class:"sidebar-header"},qe={class:"logo"},ze={key:0},Re={key:1},We={class:"sidebar-nav"},Pe={key:0},Be={__name:"Sidebar",emits:["toggle"],setup(q,{emit:m}){ie();const d=$(!1),c=m,h=[{name:"Dashboard",path:"/dashboard",icon:"bx bx-home-alt"},{name:"Tareas",path:"/tasks",icon:"bx bx-task"},{name:"Calendario",path:"/calendar",icon:"bx bx-calendar"},{name:"Wallet",path:"/wallet",icon:"bx bx-wallet"},{name:"Comidas",path:"/meals",icon:"bx bx-restaurant"},{path:"chatIA",name:"Lisy IA",icon:"bx bx-chat"},{name:"Comunidad",path:"/feed",icon:"bx bx-group"}],_=()=>{d.value=!d.value,c("toggle",d.value)};return le(d,b=>{c("toggle",b)},{immediate:!0}),(b,E)=>{const z=de("router-link");return n(),r("div",{class:w(["sidebar",{"sidebar-collapsed":d.value}])},[a("div",Me,[a("div",qe,[d.value?(n(),r("span",Re,"LS")):(n(),r("h2",ze,"LifeSync"))]),a("button",{class:"toggle-btn",onClick:_},[a("i",{class:w(["bx",d.value?"bx-menu":"bx-menu-alt-left"])},null,2)])]),a("nav",We,[(n(),r(Q,null,K(h,U=>M(z,{key:U.path,to:U.path,class:w(["nav-item",{active:b.$route.path===U.path}])},{default:Ne(()=>[a("i",{class:w(U.icon)},null,2),d.value?f("",!0):(n(),r("span",Pe,N(U.name),1))]),_:2},1032,["to","class"])),64))])],2)}}},je=J(Be,[["__scopeId","data-v-925dab9e"]]);const He={class:"navbar-brand"},Ve={class:"navbar-item is-hidden-mobile",style:{width:"350px",position:"relative"}},Fe={class:"control has-icons-left is-expanded"},Oe={key:0,class:"search-dropdown"},Qe=["onMousedown"],Ke={class:"tag"},Je=["innerHTML"],Ge={key:0},Xe=["innerHTML"],Ye={class:"navbar-menu is-active"},Ze={class:"navbar-end"},es={class:"navbar-item"},ss={key:0,class:"notification-badge"},ts={class:"navbar-item"},as={class:"navbar-item has-dropdown is-hoverable"},os={class:"navbar-link"},ns={class:"image is-32x32 is-rounded"},rs=["src","alt"],is={class:"modal-card"},ls={class:"modal-card-head"},ds={class:"modal-card-body"},cs={key:0,class:"content has-text-centered"},us={key:1,class:"notifications-list"},ps={class:"notification-avatar"},ms=["src","alt"],hs={class:"notification-content"},_s={class:"notification-header"},vs={class:"notification-time"},bs={class:"notification-message"},fs={key:0,class:"notification-actions"},gs={key:0,class:"notification-status accepted"},xs={key:1,class:"notification-status rejected"},ys={key:2,class:"notification-buttons"},ks=["onClick","disabled"],ws={key:0,class:"bx bx-loader-alt bx-spin"},Us={key:1},Is=["onClick","disabled"],Cs={key:0,class:"bx bx-loader-alt bx-spin"},Ns={key:1},$s={key:1,class:"notification-actions"},Es={class:"task-notification-info"},Ts={key:2,class:"notification-actions"},Ss={key:0},Ds=["onClick"],Ls={key:1,class:"quick-reply-input",style:{display:"flex",gap:"8px","align-items":"flex-start","padding-top":"6px"}},As=["onUpdate:modelValue","onKeyup"],Ms=["onClick","disabled"],qs={key:0,class:"bx bx-loader-alt bx-spin"},zs={key:1},Rs={key:2,class:"notification-feedback"},Ws={key:3,class:"notification-feedback"},Ps={class:"notification-delete"},Bs=["onClick"],js={class:"modal-card-foot is-justify-content-flex-end"},Hs={__name:"TopNavBar",props:{sidebarCollapsed:{type:Boolean,default:!1}},setup(q){document.getElementById("btnTheme");const m=$(!1),d=ie(),c=$([]),h=$(null),_=Te(),b=$(""),E=$(!1);function z(){const s=document.body;s.id==="theme-light"?s.id="theme-dark":s.id="theme-light"}function U(){setTimeout(()=>E.value=!1,200)}let T=null;le(()=>p.currentUser,s=>{s?(_.syncAll(),ue()):T&&(console.log("Usuario desautenticado, limpiando listener de notificaciones"),T(),T=null,c.value=[])},{immediate:!0});const ce=s=>{const t=s.target,e=t.alt||"U";t.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(e)}&size=64`};async function ue(){if(!p.currentUser)return;T&&T();const s=j(y(i,"notifications"),I("toUserId","==",p.currentUser.uid),Se("createdAt","desc")),t=await H(s),e=await Promise.all(t.docs.map(async o=>{const l=o.data();if(l.type&&(l.type.startsWith("task_")||l.type.startsWith("event_")||l.type.startsWith("feed_"))&&!l.fromUserName)try{const x=(await V(o(i,"users",l.fromUserId))).data();return{id:o.id,...l,fromUserName:(x==null?void 0:x.name)||"Usuario",fromUserPhoto:(x==null?void 0:x.photo)||null}}catch(g){return console.error("Error cargando datos de usuario:",g),{id:o.id,...l,fromUserName:"Usuario",fromUserPhoto:null}}return{id:o.id,...l}}));c.value=e,T=De(s,o=>{const l=o.docs.map(g=>({id:g.id,...g.data()}));c.value=l},o=>{console.error("Error en listener de notificaciones:",o)})}async function pe(s){if(p.currentUser){h.value=s.id;try{console.log("=== ACEPTANDO SOLICITUD DESDE NOTIFICACIÓN ==="),console.log("Notificación:",s);const t=j(y(i,"friend_requests"),I("fromUserId","==",s.fromUserId),I("toUserId","==",p.currentUser.uid),I("status","==","pending")),e=await H(t);if(e.empty)console.log("No se encontró la solicitud");else{const o=e.docs[0];console.log("Solicitud encontrada:",o.data()),await F(C(i,"friend_requests",o.id),{status:"accepted",updatedAt:k()}),await D(y(i,"friendships"),{userId:p.currentUser.uid,friendId:s.fromUserId,createdAt:k()}),await D(y(i,"friendships"),{userId:s.fromUserId,friendId:p.currentUser.uid,createdAt:k()}),await D(y(i,"notifications"),{toUserId:s.fromUserId,fromUserId:p.currentUser.uid,type:"friend_request_accepted",title:"Solicitud de amistad aceptada",message:`${u.value.name||"Alguien"} aceptó tu solicitud de amistad`,read:!1,createdAt:k()}),await F(C(i,"notifications",s.id),{read:!0,status:"accepted",message:"Solicitud de amistad aceptada",updatedAt:k()}),console.log("Solicitud aceptada correctamente"),A("Solicitud de amistad aceptada")}}catch(t){console.error("Error aceptando solicitud:",t),O("Error al aceptar la solicitud")}finally{h.value=null}}}async function me(s){if(p.currentUser){h.value=s.id;try{const t=j(y(i,"friend_requests"),I("fromUserId","==",s.fromUserId),I("toUserId","==",p.currentUser.uid),I("status","==","pending")),e=await H(t);e.empty||(await re(C(i,"friend_requests",e.docs[0].id)),await F(C(i,"notifications",s.id),{read:!0,status:"rejected",message:"Solicitud de amistad rechazada",updatedAt:k()}),A("Solicitud de amistad rechazada"))}catch(t){console.error("Error rechazando solicitud:",t),O("Error al rechazar la solicitud")}finally{h.value=null}}}function he(s){if(!s)return"";const t=s.toDate?s.toDate():new Date(s),o=Math.floor((new Date-t)/(1e3*60));return o<1?"Ahora":o<60?`Hace ${o} min`:o<1440?`Hace ${Math.floor(o/60)}h`:`Hace ${Math.floor(o/1440)}d`}const R=P(()=>{const s=c.value.filter(t=>!t.read).length;return console.log("=== COMPUTED UNREAD NOTIFICATIONS ===","No leídas:",s,"Total:",c.value.length,"Notifications array:",c.value),s});async function _e(s){try{await re(C(i,"notifications",s)),A("Notificación eliminada")}catch(t){console.error("Error eliminando notificación:",t),O("Error al eliminar la notificación")}}function ve(s){if(s.startsWith("task_"))switch(s){case"task_created":return"bx bx-plus-circle";case"task_completed":return"bx bx-check-circle";case"task_progress":return"bx bx-loader-alt";case"task_reopened":return"bx bx-refresh";case"task_due_soon":return"bx bx-time";case"task_overdue":return"bx bx-error-circle";default:return"bx bx-task"}if(s.startsWith("event_"))switch(s){case"event_two_days_before":return"bx bx-calendar-x";case"event_day_of":return"bx bx-calendar-check";default:return"bx bx-calendar"}if(s.startsWith("feed_"))switch(s){case"feed_comment":return"bx bx-comment";case"feed_reaction":return"bx bx-heart";default:return"bx bx-news"}return"bx bx-bell"}function be(s){if(s.startsWith("task_"))switch(s){case"task_created":return"#6366f1";case"task_completed":return"#06d6a0";case"task_progress":return"#f59e0b";case"task_reopened":return"#8b5cf6";case"task_due_soon":return"#ef4444";case"task_overdue":return"#dc2626";default:return"#64748b"}if(s.startsWith("event_"))switch(s){case"event_two_days_before":return"#f59e0b";case"event_day_of":return"#06d6a0";default:return"#64748b"}if(s.startsWith("feed_"))switch(s){case"feed_comment":return"#3b82f6";case"feed_reaction":return"#ef4444";default:return"#64748b"}return"#64748b"}function fe(s){if(s.startsWith("task_"))switch(s){case"task_created":return"Nueva tarea creada";case"task_completed":return"Tarea completada";case"task_progress":return"Tarea en progreso";case"task_reopened":return"Tarea reabierta";case"task_due_soon":return"Vence pronto";case"task_overdue":return"Tarea vencida";default:return"Actualización de tarea"}if(s.startsWith("event_"))switch(s){case"event_two_days_before":return"Evento en 2 días";case"event_day_of":return"Evento hoy";default:return"Actualización de evento"}if(s.startsWith("feed_"))switch(s){case"feed_comment":return"Nuevo comentario";case"feed_reaction":return"Nueva reacción";default:return"Actualización de feed"}return"Notificación"}const G=P(()=>{if(!b.value.trim())return[];const s=b.value.toLowerCase(),t=[];return _.transactions.forEach(e=>{(e.title&&e.title.toLowerCase().includes(s)||e.notes&&e.notes.toLowerCase().includes(s))&&t.push({type:"Transacción",label:e.title,id:e.id,route:"/wallet",extra:e.notes,highlight:s})}),_.meals.forEach(e=>{(e.name&&e.name.toLowerCase().includes(s)||e.description&&e.description.toLowerCase().includes(s))&&t.push({type:"Comida",label:e.name,id:e.id,route:"/meals",extra:e.description,highlight:s})}),_.tasks.forEach(e=>{(e.title&&e.title.toLowerCase().includes(s)||e.description&&e.description.toLowerCase().includes(s))&&t.push({type:"Tarea",label:e.title,id:e.id,route:"/tasks",extra:e.description,highlight:s})}),_.notes.forEach(e=>{(e.title&&e.title.toLowerCase().includes(s)||e.content&&e.content.toLowerCase().includes(s))&&t.push({type:"Nota",label:e.title,id:e.id,route:"/tasks",extra:e.content,highlight:s,isNote:!0})}),_.events&&_.events.forEach(e=>{(e.title&&e.title.toLowerCase().includes(s)||e.description&&e.description.toLowerCase().includes(s))&&t.push({type:"Evento",label:e.title,id:e.id,route:"/calendar",extra:e.description,highlight:s})}),t});function ge(s){d.push({path:s.route,query:{highlight:s.id,type:s.type}}),E.value=!1,b.value=""}const X=q;function Y(s,t){if(!s||!t)return s;const e=new RegExp(`(${t})`,"gi");return s.replace(e,"<mark>$1</mark>")}const xe=P(()=>{if(window.innerWidth<=768)return{};const s=X.sidebarCollapsed?"70px":"250px",t=X.sidebarCollapsed?"calc(100% - 70px)":"calc(100% - 250px)";return{left:s,width:t,position:"fixed",top:"0",zIndex:20,transition:"left 0.3s, width 0.3s"}}),ye=()=>{d.push({name:"profile"})},ke=async()=>{const s=Le();Ae(s).then(()=>{localStorage.setItem("isLoggedIn","false"),A("sesion finalizada"),d.push("/login")}).catch(t=>{console.log(`Error al cerrar la sesion: ${t.message}`)})},u=L({name:"",photo:""});async function we(){const s=p.currentUser;if(!s)return;const t=await V(C(i,"users",s.uid));if(t.exists()){const e=t.data();u.name=e.name,u.photo=e.photo}}$e(()=>{we()});function Ue(s){s.target.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(u.name||"U")}&size=64`}const S=L({}),v=L({}),W=L({});typeof window<"u"&&(window.localPendingMessages||(window.localPendingMessages=[]));const Z=async s=>{var o,l;const t=(o=S[s.id])==null?void 0:o.trim(),e=(l=p.currentUser)==null?void 0:l.uid;if(!t||!e){v[s.id]="error",console.error("No se puede enviar: UID de usuario no definido o mensaje vacío"),setTimeout(()=>v[s.id]=null,2e3);return}try{const x={id:`pending-${Date.now()}-${Math.random()}`,text:t,author:u.name,senderId:e,receiverId:s.fromUserId,pending:!0};typeof window<"u"&&window.localPendingMessages&&window.localPendingMessages.push(x);const Ie={text:t,author:u.name,timestamp:k(),senderId:e,receiverId:s.fromUserId,read:!1};await D(y(i,"messages"),Ie);const ee=await V(C(i,"users",e)),se=ee.exists()?ee.data():{},Ce={toUserId:s.fromUserId,fromUserId:e,fromUserName:se.name||u.name||"Usuario",fromUserPhoto:se.photo||u.photo||null,type:"dm_message",title:"Nuevo mensaje de tu amigo",message:t,chatUserId:e,read:!1,createdAt:k()};await D(y(i,"notifications"),Ce),v[s.id]="enviado",S[s.id]="",W[s.id]=!1,setTimeout(()=>v[s.id]=null,2e3)}catch(g){console.error("Error al enviar respuesta rápida:",g),v[s.id]="error",setTimeout(()=>v[s.id]=null,2e3)}};return(s,t)=>(n(),r("nav",{class:"navbar top-navbar",role:"navigation","aria-label":"main navigation",style:ne(xe.value)},[a("div",He,[t[9]||(t[9]=a("div",{class:"navbar-item is-hidden-desktop"},[a("span",{class:"icon"},[a("i",{class:"bx bx-search"})])],-1)),a("div",Ve,[a("div",Fe,[te(a("input",{class:"input",type:"text",placeholder:"Buscar...","onUpdate:modelValue":t[0]||(t[0]=e=>b.value=e),onFocus:t[1]||(t[1]=e=>E.value=!0),onInput:t[2]||(t[2]=e=>E.value=!0),onBlur:U},null,544),[[ae,b.value]]),t[7]||(t[7]=a("span",{class:"icon is-left"},[a("i",{class:"bx bx-search"})],-1))]),E.value&&G.value.length?(n(),r("div",Oe,[(n(!0),r(Q,null,K(G.value,(e,o)=>(n(),r("div",{key:e.type+e.id+o,class:"search-result-item",onMousedown:oe(l=>ge(e),["prevent"])},[a("span",Ke,N(e.type),1),a("span",{innerHTML:Y(e.label,e.highlight)},null,8,Je),e.extra?(n(),r("small",Ge,[t[8]||(t[8]=B(" - ")),a("span",{innerHTML:Y(e.extra,e.highlight)},null,8,Xe)])):f("",!0)],40,Qe))),128))])):f("",!0)])]),a("div",Ye,[a("div",Ze,[a("div",es,[a("button",{class:"button nav-button",onClick:t[3]||(t[3]=e=>m.value=!0)},[t[10]||(t[10]=a("span",{class:"icon"},[a("i",{class:"bx bx-bell"})],-1)),R.value>0?(n(),r("span",ss,N(R.value>9?"9+":R.value),1)):f("",!0)])]),a("div",ts,[a("button",{class:"button nav-button",onClick:oe(z,["prevent"])},t[11]||(t[11]=[a("span",{class:"icon"},[a("i",{class:"bx bx-moon"})],-1)]))]),t[15]||(t[15]=a("div",{class:"navbar-item"},[a("button",{class:"button nav-button"},[a("span",{class:"icon"},[a("i",{class:"bx bx-globe"})])])],-1)),a("div",as,[a("a",os,[a("figure",ns,[a("img",{class:"is-rounded",src:u.photo?u.photo:`https://ui-avatars.com/api/?name=${encodeURIComponent(u.name||"U")}&size=64`,alt:`Foto de ${u.name}`,onError:Ue},null,40,rs)])]),a("div",{class:"navbar-dropdown is-right"},[a("a",{class:"navbar-item",onClick:ye},t[12]||(t[12]=[a("span",{class:"icon"},[a("i",{class:"bx bx-user"})],-1),B(" Perfil ")])),t[14]||(t[14]=a("hr",{class:"navbar-divider"},null,-1)),a("a",{class:"navbar-item",onClick:ke},t[13]||(t[13]=[a("span",{class:"icon"},[a("i",{class:"bx bx-log-out"})],-1),B(" Logout ")]))])])])]),a("div",{class:w(["modal",{"is-active":m.value}])},[a("div",{class:"modal-background",onClick:t[4]||(t[4]=e=>m.value=!1)}),a("div",is,[a("header",ls,[t[16]||(t[16]=a("p",{class:"modal-card-title"},"Notificaciones",-1)),a("button",{class:"delete","aria-label":"close",onClick:t[5]||(t[5]=e=>m.value=!1)})]),a("section",ds,[c.value.length===0?(n(),r("div",cs,t[17]||(t[17]=[a("span",{class:"icon is-large mb-2"},[a("i",{class:"bx bx-bell is-size-2"})],-1),a("p",null,"No hay notificaciones nuevas.",-1)]))):(n(),r("div",us,[(n(!0),r(Q,null,K(c.value,e=>(n(),r("div",{key:e.id,class:w(["notification-item",{unread:!e.read}])},[a("div",ps,[a("img",{src:e.fromUserPhoto||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.fromUserName||"U")}&size=64`,alt:e.fromUserName,onError:ce},null,40,ms)]),a("div",hs,[a("div",_s,[a("strong",null,N(e.title),1),a("small",vs,N(he(e.createdAt)),1)]),a("p",bs,N(e.message),1),e.type==="friend_request"?(n(),r("div",fs,[e.status==="accepted"?(n(),r("div",gs,t[18]||(t[18]=[a("i",{class:"bx bx-check-circle"},null,-1),a("span",null,"Solicitud aceptada",-1)]))):e.status==="rejected"?(n(),r("div",xs,t[19]||(t[19]=[a("i",{class:"bx bx-x-circle"},null,-1),a("span",null,"Solicitud rechazada",-1)]))):(n(),r("div",ys,[a("button",{class:"button is-success is-small",onClick:o=>pe(e),disabled:h.value===e.id},[h.value===e.id?(n(),r("i",ws)):(n(),r("span",Us,"Aceptar"))],8,ks),a("button",{class:"button is-danger is-small",onClick:o=>me(e),disabled:h.value===e.id},[h.value===e.id?(n(),r("i",Cs)):(n(),r("span",Ns,"Rechazar"))],8,Is)]))])):f("",!0),e.type&&(e.type.startsWith("task_")||e.type.startsWith("event_")||e.type.startsWith("feed_"))?(n(),r("div",$s,[a("div",Es,[a("i",{class:w(ve(e.type)),style:ne({color:be(e.type)})},null,6),a("span",null,N(fe(e.type)),1)])])):f("",!0),e.type==="dm_message"?(n(),r("div",Ts,[W[e.id]?(n(),r("div",Ls,[te(a("input",{type:"text",class:"input",placeholder:"Escribe tu respuesta...","onUpdate:modelValue":o=>S[e.id]=o,onKeyup:Ee(o=>Z(e),["enter"]),autofocus:""},null,40,As),[[ae,S[e.id]]]),a("button",{class:"button is-success is-small",onClick:o=>Z(e),disabled:!S[e.id]||v[e.id]==="enviando",style:{"margin-top":"2px"}},[v[e.id]==="enviando"?(n(),r("i",qs)):(n(),r("span",zs,"Enviar"))],8,Ms)])):(n(),r("div",Ss,[a("button",{class:"button is-link is-small",onClick:o=>W[e.id]=!0},t[20]||(t[20]=[a("i",{class:"bx bx-reply"},null,-1),a("span",null,"Responder",-1)]),8,Ds)])),v[e.id]==="enviado"?(n(),r("div",Rs,t[21]||(t[21]=[a("span",{class:"icon is-small"},[a("i",{class:"bx bx-check-circle"})],-1),a("span",null,"Mensaje enviado",-1)]))):f("",!0),v[e.id]==="error"?(n(),r("div",Ws,t[22]||(t[22]=[a("span",{class:"icon is-small"},[a("i",{class:"bx bx-x-circle"})],-1),a("span",null,"Error al enviar",-1)]))):f("",!0)])):f("",!0)]),a("div",Ps,[a("button",{class:"button is-small is-light",onClick:o=>_e(e.id),title:"Eliminar notificación"},t[23]||(t[23]=[a("i",{class:"bx bx-trash"},null,-1)]),8,Bs)])],2))),128))]))]),a("footer",js,[a("button",{class:"button",onClick:t[6]||(t[6]=e=>m.value=!1)}," Cerrar ")])])],2)],4))}},Vs=J(Hs,[["__scopeId","data-v-021414cc"]]);const Fs={class:"layout"},Os={class:"main-wrapper"},Qs={__name:"Layout",setup(q){const m=$(!1),d=c=>{m.value=c};return(c,h)=>{const _=de("router-view");return n(),r("div",Fs,[M(je,{onToggle:d}),a("div",Os,[M(Vs,{"sidebar-collapsed":m.value},null,8,["sidebar-collapsed"]),a("main",{class:w(["main-content",{"sidebar-collapsed":m.value}])},[M(_)],2)])])}}},st=J(Qs,[["__scopeId","data-v-6a0be047"]]);export{st as default};
